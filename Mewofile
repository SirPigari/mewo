; Mewo Build File for building and running Mewo

call build

build:
    #windows gcc source/main.c -o mewo.new.exe -g
    #linux gcc source/main.c -o mewo.new -g
    echo Building complete

#windows release:
    call "${#env(vsDevCmd, C:\\Program Files (x86)\\Microsoft Visual Studio\\2022\\BuildTools\\Common7\\Tools\\VsDevCmd.bat)}" -arch=x64 && clang-cl source\main.c /Os /MT /D_CRT_SECURE_NO_WARNINGS /Oi /Ot /Gy /link /OPT:REF /OPT:ICF /SUBSYSTEM:CONSOLE /OUT:mewo.new.exe
    echo Built mewo.new.exe (${#sizeof(file, mewo.new.exe, KiB)} KiB)

#linux release:
    musl-gcc source/main.c -o mewo.new -Os -static -flto -fdata-sections -ffunction-sections -Wl,--gc-sections -s
    echo "Built mewo.new (${#sizeof(file, mewo.new, KiB)} KiB)"

#macos release:
    gcc source/main.c -o mewo.new -Os -flto -fdata-sections -ffunction-sections
    strip mewo.new
    chmod +x mewo.new
    echo "Built mewo.new (${#sizeof(file, mewo.new, KiB)} KiB)"

#windows install:
    powershell.exe -NoProfile -Command "$dir = \"$env:LOCALAPPDATA\Programs\mewo\"; if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir | Out-Null }; $dst = \"$dir\mewo.exe\"; $src = (Resolve-Path '.\mewo.new.exe'); $mode = ''; if (Test-Path $dst) { try { Remove-Item $dst -Force -ErrorAction Stop } catch { $tmp = \"$dst.tmp\"; Copy-Item $src $tmp -Force; Move-Item $tmp $dst -Force; $mode = 'copied (file was in use)' } }; if (-not $mode) { try { New-Item -ItemType HardLink -Path $dst -Target $src -ErrorAction Stop | Out-Null; $mode = 'hardlinked' } catch { Copy-Item $src $dst -Force; $mode = 'copied' } }; $userPath = [Environment]::GetEnvironmentVariable('PATH','User'); if ($userPath -notlike \"*$dir*\") { [Environment]::SetEnvironmentVariable('PATH', \"$userPath;$dir\", 'User') }; $env:PATH += \";$dir\"; Write-Host \"Mewo installed ($mode)\""
    echo Mewo installed to %LOCALAPPDATA%\Programs\mewo\mewo.exe
    mewo.exe --version

#unix install:
    sudo ln -sf $(pwd)/mewo.new /usr/local/bin/mewo
    echo "Mewo installed to /usr/local/bin/mewo"
    mewo --version

run:
    #windows mewo.new.exe ${argv}
    #unix ./mewo.new ${argv}
